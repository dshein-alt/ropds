{% extends "base.html" %}

{% block title %}{{ t.nav.books }} — {{ app_title }}{% endblock %}

{% block content %}
  {% if back_url is defined %}
  <h4 class="mb-3">
    {{ back_label }}
    {% if search_label is defined %}
    <small class="text-body-secondary">/ {{ search_label }}</small>
    {% endif %}
  </h4>
  <nav class="mb-3">
    <a href="{{ back_url }}" class="text-decoration-none">
      <i class="bi bi-arrow-left me-1"></i>{{ back_label }}
    </a>
  </nav>
  {% elif search_label is defined %}
  <h4 class="mb-3">{{ search_label }}</h4>
  {% endif %}

  {% if books | length == 0 %}
    <p class="text-body-secondary">{{ t.common.no_results }}</p>
  {% else %}
    <div class="row g-3">
    {% for item in books %}
      <div class="col-12">
        <div class="card book-card">
          <div class="card-body">
            <div class="d-flex gap-3">

              {# Cover #}
              {% if show_covers %}
              <div class="flex-shrink-0">
                {% if item.cover %}
                <img src="/opds/thumb/{{ item.id }}/" alt="" class="book-cover rounded cover-preview" data-cover-url="/opds/cover/{{ item.id }}/">
                {% else %}
                <img src="/static/images/nocover.svg" alt="" class="book-cover rounded">
                {% endif %}
              </div>
              {% endif %}

              {# Details #}
              <div class="flex-grow-1 min-width-0">
                <h5 class="card-title mb-1">{{ item.title }}</h5>

                {# Authors #}
                {% if item.authors | length > 0 %}
                <div class="mb-1">
                  <i class="bi bi-person text-body-secondary me-1"></i>
                  {% for author in item.authors %}
                    <a href="/web/search/books?type=a&q={{ author.id }}" class="text-decoration-none">{{ author.full_name }}</a>{% if not loop.last %}, {% endif %}
                  {% endfor %}
                </div>
                {% endif %}

                {# Genres #}
                <div class="mb-1 book-genres-container" data-book-id="{{ item.id }}">
                  {% if item.genres | length > 0 %}
                  <i class="bi bi-tags text-body-secondary me-1"></i>
                  <span class="book-genres-badges">
                  {% for genre in item.genres %}
                    <a href="/web/search/books?type=g&q={{ genre.id }}" class="badge text-bg-light text-decoration-none">{{ genre.subsection }}</a>
                  {% endfor %}
                  </span>
                  {% endif %}
                  {% if is_superuser %}
                  <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 ms-1 btn-edit-book"
                          data-book-id="{{ item.id }}" title="{{ t.book.edit_genres }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  {% endif %}
                </div>

                {# Series #}
                {% if item.series_list | length > 0 %}
                <div class="mb-1">
                  <i class="bi bi-collection text-body-secondary me-1"></i>
                  {% for s in item.series_list %}
                    <a href="/web/search/books?type=s&q={{ s.id }}" class="text-decoration-none">{{ s.ser_name }}</a>{% if s.ser_no > 0 %} <span class="text-body-secondary">#{{ s.ser_no }}</span>{% endif %}{% if not loop.last %}, {% endif %}
                  {% endfor %}
                </div>
                {% endif %}

                {# Metadata line #}
                <div class="small text-body-secondary mb-2">
                  <span class="badge text-bg-secondary">{{ item.format }}</span>
                  {% if item.doubles > 1 %}<span class="badge text-bg-info">{{ item.doubles }} formats</span>{% endif %}
                  {{ item.size | filesizeformat }}
                  {% if item.lang and item.lang != "un" %}· {{ item.lang }}{% endif %}
                  {% if item.docdate and item.docdate != "" %}· {{ item.docdate }}{% endif %}
                </div>

                {# Download buttons #}
                <div class="btn-group btn-group-sm">
                  <a href="/web/download/{{ item.id }}/0" class="btn btn-primary">
                    <i class="bi bi-download me-1"></i>{{ item.format }}
                  </a>
                  {% if item.show_zip %}
                  <a href="/web/download/{{ item.id }}/1" class="btn btn-outline-primary">{{ item.format }}+zip</a>
                  {% endif %}
                </div>

                {# Star/bookshelf toggle #}
                {% if is_authenticated %}
                <form method="post" action="/web/bookshelf/toggle" class="d-inline ms-2">
                  <input type="hidden" name="book_id" value="{{ item.id }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="redirect" value="{{ current_path | default(value='/web') }}">
                  <button type="submit" class="btn btn-sm bookshelf-toggle-btn {% if item.on_bookshelf %}btn-warning{% else %}btn-outline-secondary{% endif %}" title="{% if item.on_bookshelf %}{{ t.bookshelf.remove }}{% else %}{{ t.bookshelf.add }}{% endif %}">
                    <i class="bi {% if item.on_bookshelf %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                  </button>
                </form>
                {% endif %}

                {# Annotation #}
                {% if item.annotation and item.annotation != "" %}
                <details class="mt-2">
                  <summary class="small text-body-secondary">{{ t.book.annotation }}</summary>
                  <p class="small mt-1">{{ item.annotation | truncate(length=600) }}</p>
                </details>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
    </div>
  {% endif %}

  {% if pagination.total_pages > 1 %}
  {% include "web/_pagination.html" %}
  {% endif %}

  {% if is_superuser %}
  {# ── Book Edit Modal (admin-only) ───────────────── #}
  <div class="modal fade" id="bookEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil me-2"></i><span id="edit-modal-title"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          {# ── Title Editor ─── #}
          <h6><i class="bi bi-type me-1"></i>{{ t.book.edit_title }}</h6>
          <div class="mb-3">
            <input type="text" id="edit-book-title" class="form-control"
                   maxlength="256" placeholder="{{ t.book.title_placeholder }}">
            <div id="edit-title-error" class="invalid-feedback"></div>
          </div>

          {# ── Genre Editor ─── #}
          <h6><i class="bi bi-tags me-1"></i>{{ t.book.edit_genres }}</h6>
          <div id="edit-genre-sections" class="accordion accordion-flush border rounded mb-2" style="max-height: 300px; overflow-y: auto;"></div>
          <div class="mb-3 small text-body-secondary">
            <span id="edit-genre-count">0</span> {{ t.book.genres_selected }}
          </div>

          {# ── Author Editor ─── #}
          <h6><i class="bi bi-person me-1"></i>{{ t.book.edit_authors }}</h6>
          <div id="edit-authors-list" class="mb-2"></div>
          <div class="input-group input-group-sm mb-2">
            <input type="text" id="edit-new-author" class="form-control" placeholder="{{ t.book.author_name }}">
            <button type="button" id="edit-add-author" class="btn btn-outline-primary">
              <i class="bi bi-plus-lg me-1"></i>{{ t.book.add_author }}
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.admin.cancel }}</button>
          <button type="button" id="edit-save-btn" class="btn btn-primary">
            <span id="edit-save-text">{{ t.admin.save }}</span>
            <span id="edit-save-spinner" class="d-none"><span class="spinner-border spinner-border-sm me-1"></span></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    var csrfToken = "{{ csrf_token }}";
    var editBookId = null;
    var editAuthors = []; // [{id, full_name}]
    var newAuthors = [];  // [string]
    var modal = null;

    // Open modal
    document.addEventListener("click", function(e) {
      var btn = e.target.closest(".btn-edit-book");
      if (!btn) return;
      editBookId = parseInt(btn.dataset.bookId, 10);

      // Gather current genres from badges
      var card = btn.closest(".col-12");
      var genreBadges = card.querySelectorAll(".book-genres-badges a");
      var currentGenreIds = [];
      genreBadges.forEach(function(a) {
        var href = a.getAttribute("href");
        var match = href && href.match(/q=(\d+)/);
        if (match) currentGenreIds.push(parseInt(match[1], 10));
      });

      // Gather current authors
      var authorLinks = card.querySelectorAll(".mb-1 a[href*='type=a']");
      editAuthors = [];
      authorLinks.forEach(function(a) {
        var href = a.getAttribute("href");
        var match = href && href.match(/q=(\d+)/);
        if (match) {
          editAuthors.push({ id: parseInt(match[1], 10), full_name: a.textContent.trim() });
        }
      });
      newAuthors = [];

      // Set modal title
      var titleEl = card.querySelector(".card-title");
      document.getElementById("edit-modal-title").textContent = titleEl ? titleEl.textContent : "";

      // Pre-fill title input
      var titleInput = document.getElementById("edit-book-title");
      titleInput.value = titleEl ? titleEl.textContent.trim() : "";
      titleInput.classList.remove("is-invalid");

      // Build genre selector
      var genreContainer = document.getElementById("edit-genre-sections");
      GenreSelector.fetchGenres().then(function(sections) {
        GenreSelector.build(genreContainer, sections, {
          selectedIds: currentGenreIds,
          onChange: function(ids) {
            document.getElementById("edit-genre-count").textContent = ids.length;
          }
        });
        document.getElementById("edit-genre-count").textContent = currentGenreIds.length;
      });

      // Build author list
      renderAuthors();

      if (!modal) modal = new bootstrap.Modal(document.getElementById("bookEditModal"));
      modal.show();
    });

    function renderAuthors() {
      var container = document.getElementById("edit-authors-list");
      var html = "";
      editAuthors.forEach(function(a, i) {
        html += '<span class="badge bg-secondary me-1 mb-1">' +
          a.full_name +
          ' <button type="button" class="btn-close btn-close-white ms-1" style="font-size:0.6em" data-remove-author="' + i + '"></button>' +
          '</span>';
      });
      newAuthors.forEach(function(name, i) {
        html += '<span class="badge bg-info me-1 mb-1">' +
          name +
          ' <button type="button" class="btn-close btn-close-white ms-1" style="font-size:0.6em" data-remove-new="' + i + '"></button>' +
          '</span>';
      });
      container.innerHTML = html;
    }

    // Remove author badge
    document.addEventListener("click", function(e) {
      var btn = e.target.closest("[data-remove-author]");
      if (btn) {
        var idx = parseInt(btn.dataset.removeAuthor, 10);
        editAuthors.splice(idx, 1);
        renderAuthors();
        return;
      }
      var btn2 = e.target.closest("[data-remove-new]");
      if (btn2) {
        var idx2 = parseInt(btn2.dataset.removeNew, 10);
        newAuthors.splice(idx2, 1);
        renderAuthors();
      }
    });

    // Add new author
    document.getElementById("edit-add-author").addEventListener("click", function() {
      var input = document.getElementById("edit-new-author");
      var name = input.value.trim();
      if (name) {
        newAuthors.push(name);
        input.value = "";
        renderAuthors();
      }
    });
    document.getElementById("edit-new-author").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("edit-add-author").click();
      }
    });

    var TITLE_ERRORS = {
      title_empty: "{{ t.book.error_title_empty }}",
      title_too_long: "{{ t.book.error_title_too_long }}",
      title_invalid: "{{ t.book.error_title_invalid }}"
    };

    function validateTitle(value) {
      var trimmed = value.trim();
      if (!trimmed) return "title_empty";
      if ([...trimmed].length > 256) return "title_too_long";
      for (var i = 0; i < trimmed.length; i++) {
        var code = trimmed.charCodeAt(i);
        if (code < 32) return "title_invalid";
      }
      return null; // valid
    }

    function showTitleError(errKey) {
      var input = document.getElementById("edit-book-title");
      var errorDiv = document.getElementById("edit-title-error");
      input.classList.add("is-invalid");
      errorDiv.textContent = TITLE_ERRORS[errKey] || errKey;
    }

    // Save
    document.getElementById("edit-save-btn").addEventListener("click", async function() {
      var saveBtn = this;
      saveBtn.disabled = true;
      document.getElementById("edit-save-text").classList.add("d-none");
      document.getElementById("edit-save-spinner").classList.remove("d-none");

      try {
        // Save title (if changed)
        var titleInput = document.getElementById("edit-book-title");
        var newTitle = titleInput.value.trim();
        var originalTitle = document.getElementById("edit-modal-title").textContent.trim();
        if (newTitle !== originalTitle) {
          var titleErr = validateTitle(newTitle);
          if (titleErr) {
            showTitleError(titleErr);
            throw new Error("invalid title");
          }
          var titleResp = await fetch("/web/admin/book-title", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ book_id: editBookId, title: newTitle, csrf_token: csrfToken })
          });
          var titleData = await titleResp.json();
          if (!titleData.ok) {
            showTitleError(titleData.error || "title_invalid");
            throw new Error("title save failed");
          }
          // Update DOM — card title
          var cardEl = document.querySelector('.btn-edit-book[data-book-id="' + editBookId + '"]');
          if (cardEl) {
            var bookCard = cardEl.closest(".col-12");
            var cardTitle = bookCard.querySelector(".card-title");
            if (cardTitle) cardTitle.textContent = titleData.title;
          }
          // Update modal header
          document.getElementById("edit-modal-title").textContent = titleData.title;
        }

        // Save genres
        var genreIds = GenreSelector.getSelected(document.getElementById("edit-genre-sections"));
        var genreResp = await fetch("/web/admin/book-genres", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({ book_id: editBookId, genre_ids: genreIds, csrf_token: csrfToken })
        });
        var genreData = await genreResp.json();

        // Save authors
        var authorIds = editAuthors.map(function(a) { return a.id; });
        var authorResp = await fetch("/web/admin/book-authors", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify({ book_id: editBookId, author_ids: authorIds, new_authors: newAuthors, csrf_token: csrfToken })
        });
        var authorData = await authorResp.json();

        // Update DOM - genres
        if (genreData.ok) {
          var card = document.querySelector('.book-genres-container[data-book-id="' + editBookId + '"]');
          if (card) {
            var badgesSpan = card.querySelector(".book-genres-badges");
            if (!badgesSpan) {
              // No genres previously — add icon and badges span
              var icon = document.createElement("i");
              icon.className = "bi bi-tags text-body-secondary me-1";
              card.insertBefore(icon, card.querySelector(".btn-edit-book"));
              badgesSpan = document.createElement("span");
              badgesSpan.className = "book-genres-badges";
              card.insertBefore(badgesSpan, card.querySelector(".btn-edit-book"));
            }
            badgesSpan.innerHTML = genreData.genres.map(function(g) {
              return '<a href="/web/search/books?type=g&q=' + g.id + '" class="badge text-bg-light text-decoration-none">' + g.subsection + '</a>';
            }).join("");
          }
        }

        // Update DOM - authors
        if (authorData.ok) {
          var cardEl = document.querySelector('.btn-edit-book[data-book-id="' + editBookId + '"]');
          if (cardEl) {
            var bookCard = cardEl.closest(".col-12");
            var authorDiv = bookCard.querySelector(".mb-1:has(.bi-person)");
            if (!authorDiv) {
              // Find the right place to insert
              authorDiv = document.createElement("div");
              authorDiv.className = "mb-1";
              var titleEl = bookCard.querySelector(".card-title");
              if (titleEl) titleEl.after(authorDiv);
            }
            authorDiv.innerHTML = '<i class="bi bi-person text-body-secondary me-1"></i>' +
              authorData.authors.map(function(a) {
                return '<a href="/web/search/books?type=a&q=' + a.id + '" class="text-decoration-none">' + a.full_name + '</a>';
              }).join(", ");
          }
        }

        if (modal) modal.hide();
      } catch (err) {
        console.error("Save failed:", err);
      } finally {
        saveBtn.disabled = false;
        document.getElementById("edit-save-text").classList.remove("d-none");
        document.getElementById("edit-save-spinner").classList.add("d-none");
      }
    });
  })();
  </script>
  {% endif %}
{% endblock %}
