# ROPDS

[![CI](https://github.com/dshein-alt/ropds/actions/workflows/tag-tests.yml/badge.svg?branch=master)](https://github.com/dshein-alt/ropds/actions/workflows/tag-tests.yml)

**Rust OPDS Server** — быстрый и легковесный сервер персональной электронной библиотеки с каталогом OPDS и веб-интерфейсом.

> Вдохновлён проектом [SimpleOPDS](https://github.com/mitshel/sopds).
> Написан с нуля на Rust как современная альтернатива для самостоятельного развёртывания.

[English version](README.md)

## Зачем ROPDS?

Цель проста: **персональный сервер библиотеки, который можно настроить один раз и забыть.** Легко разворачивается на домашнем сервере или VPS для себя, семьи и друзей.

- **Быстрый и экономичный** — один бинарник на Rust, без внешних зависимостей, контейнеры опциональны
- **Простое развёртывание** — SQLite из коробки, Docker-наборы для PostgreSQL и MySQL/MariaDB
- **Совместим с OPDS 1.2** — работает с любой OPDS-читалкой (KOReader, Moon+ Reader, Librera и др.)
- **Встроенная читалка** — чтение EPUB, FB2, MOBI, DjVu и PDF прямо в браузере с сохранением позиции
- **Книжная полка и загрузка** — персональные списки чтения и загрузка книг с автоизвлечением метаданных
- **Адаптивный веб-интерфейс** — просмотр, поиск и управление библиотекой со светлой и тёмной темой

Проект также является **учебным pet-проектом** для изучения современной экосистемы Rust с активным использованием **конкурентных LLM-агентов** в процессе разработки.

## Возможности

**Управление библиотекой**
- Автоматическое фоновое сканирование по настраиваемому расписанию
- Параллельное сканирование с помощью пула потоков Rayon
- Поддержка книг внутри ZIP-архивов и индексных файлов INPX
- Извлечение метаданных для FB2, EPUB и MOBI (название, авторы, жанры, серии, обложки, аннотации)
- Генерация обложек для PDF/DjVu через внешние утилиты (`pdftoppm`, `ddjvu`)

**Каталог OPDS**
- Полные Atom-фиды OPDS 1.2 с пагинацией
- Навигация по авторам, сериям, жанрам, каталогам и алфавитному указателю
- Поддержка OpenSearch
- Миниатюры обложек и полноразмерные изображения
- HTTP Basic Auth (отключается в настройках)

**Поиск**
- Полнотекстовый поиск по названиям книг, авторам и сериям — из OPDS и веб-интерфейса
- Алфавитная навигация с настраиваемым порогом разбиения для больших коллекций
- Дескриптор OpenSearch для интеграции с OPDS-клиентами

**Книжная полка**
- Персональный список чтения для каждого пользователя с добавлением/удалением в один клик
- Книги автоматически добавляются на полку при скачивании
- Сортировка по дате добавления, названию или автору — по возрастанию и убыванию
- Бесконечная прокрутка для удобного просмотра

**Загрузка книг**
- Загрузка книг прямо через веб-интерфейс (FB2, EPUB, PDF и другие поддерживаемые форматы)
- Метаданные извлекаются автоматически с возможностью редактирования на лету — название, авторы и жанры перед сохранением
- Индивидуальные права на загрузку, управляемые администратором

**Жанры**
- Иерархическая система жанров с разделами и подкатегориями
- Переводы жанров на разные языки, хранящиеся в базе данных
- Административный интерфейс для создания разделов, добавления жанров и управления переводами
- Гибкая система тегов — несколько жанров на книгу, редактирование в любой момент

**Управление пользователями**
- Многопользовательская система со встроенной панелью администратора
- Создание и удаление пользователей, сброс паролей, управление правами на загрузку
- Пользователи управляют своим профилем: отображаемое имя и пароль
- Принудительная смена пароля при первом входе (если задано администратором)

**Встроенная читалка**
- Чтение EPUB, FB2, MOBI, DjVu и PDF прямо в браузере — без скачивания
- Автоматическое сохранение и восстановление позиции чтения для каждого пользователя
- Боковая панель с историей чтения и быстрым доступом к недавним книгам
- В браузере читалка открывается в новой вкладке, а в установленном PWA — в том же окне
- Работает на базе [foliate-js](https://github.com/johnfactotum/foliate-js) и [djvu.js](https://github.com/RussCoder/djvujs)

**Веб-интерфейс**
- Адаптивный интерфейс на Bootstrap 5 со светлой и тёмной темой
- Устанавливаемый PWA-режим для мобильных и десктопных браузеров (manifest + service worker)
- Навигация по каталогам, авторам, сериям и жанрам с хлебными крошками
- Редактирование метаданных книг прямо на странице для администраторов (название, авторы, жанры)
- Страница дубликатов в админке: группы дубликатов по названию и авторам с пагинацией
- Предпросмотр обложек с полноразмерным показом по клику

**Локализация**
- В комплекте **английская** и **русская** локали
- Файлы локалей — простой TOML: для добавления нового языка достаточно скопировать `en.toml` и перевести строки
- Названия жанров поддерживают переводы на разные языки, хранящиеся в базе данных
- Языковые предпочтения пользователя сохраняются в cookie

**Безопасность**
- Хеширование паролей Argon2
- Сессионные куки с подписью HMAC-SHA256
- Настраиваемое время жизни сессий
- Индивидуальные права на загрузку книг
- Роль суперпользователя для доступа к администрированию

## Быстрый старт

### 1. Сборка

```bash
cargo build --release
```

### 2. Настройка

```bash
cp config.toml.example config.toml
```

Отредактируйте `config.toml` — как минимум укажите `library.root_path`:

```toml
[library]
root_path = "/path/to/books"

[covers]
covers_path = "/path/to/books/covers"
cover_max_dimension_px = 600
cover_jpeg_quality = 85
show_covers = true

[database]
url = "sqlite://ropds.db?mode=rwc"
```

### 3. Создание администратора

```bash
./target/release/ropds --set-admin <пароль>
```

### 4. Запуск

```bash
./target/release/ropds
```

Сервер запускается на `http://localhost:8081`. Откройте `/web` для веб-интерфейса или укажите `/opds` в OPDS-читалке.

### Разовое сканирование

Для однократного сканирования библиотеки без запуска сервера:

```bash
./target/release/ropds --scan
```

## Systemd-сервис

Используйте шаблон юнита из `service/ropds.unit` (сервис запускается от пользователя `ropds`).

```bash
sudo useradd --system --home /opt/ropds --shell /usr/sbin/nologin ropds || true
sudo install -d -o ropds -g ropds /opt/ropds
sudo install -m 0755 target/release/ropds /opt/ropds/ropds
sudo install -m 0644 config.toml /opt/ropds/config.toml
sudo install -m 0644 service/ropds.unit /etc/systemd/system/ropds.service
sudo systemctl daemon-reload
sudo systemctl enable --now ropds.service
sudo systemctl status ropds.service
sudo journalctl -u ropds.service -f
```

## Docker

Для контейнерного развёртывания используйте готовый набор в [`docker/`](docker/):

- Английская инструкция: [`docker/README.md`](docker/README.md)
- Русская инструкция: [`docker/README_RU.md`](docker/README_RU.md)

## Reverse Proxy

Готовые примеры конфигурации reverse proxy:

- Английская версия: [`service/proxy/README.md`](service/proxy/README.md) (Nginx + Traefik)
- Русская версия: [`service/proxy/README_RU.md`](service/proxy/README_RU.md) (Nginx + Traefik)

## Настройка

Все параметры находятся в `config.toml`. Полный пример с комментариями: [config.toml.example](config.toml.example).

| Секция | Основные параметры |
|---|---|
| `[server]` | Адрес, порт, уровень логирования, секрет сессии и TTL |
| `[library]` | Путь к книгам, расширения файлов, поддержка ZIP/INPX |
| `[covers]` | `covers_path`, обработка обложек (`cover_max_dimension_px`, `cover_jpeg_quality`), `show_covers` |
| `[database]` | URL подключения — `sqlite://`, `postgres://` или `mysql://` |
| `[opds]` | Название каталога, пагинация, авторизация |
| `[scanner]` | Расписание в стиле cron, параллельные потоки, проверки целостности |
| `[web]` | Язык по умолчанию (`en`, `ru`), тема (`light`, `dark`) |
| `[upload]` | Включение загрузки, директория, лимит размера файла |
| `[reader]` | Включение встроенной читалки, размер истории чтения |

## Поддерживаемые форматы

| Формат | Метаданные | Обложки |
|---|---|---|
| FB2 | Полные (название, авторы, жанры, серии, аннотация, язык) | Встроенные |
| EPUB | Полные (метаданные OPF) | Встроенные |
| PDF | Название, автор (через `pdfinfo`) | Первая страница (через `pdftoppm`) |
| DjVu | Только имя файла | Первая страница (через `ddjvu`) |
| MOBI | Название, автор, описание, язык, дата | Встроенная |
| DOC, DOCX | Только имя файла | — |

Книги внутри **ZIP-архивов** сканируются прозрачно. **INPX**-файлы поддерживаются как альтернатива сканированию отдельных архивов.

## База данных

SQLite — выбор по умолчанию, не требует настройки. PostgreSQL и MySQL также поддерживаются через параметр `[database].url`.

Миграции выполняются автоматически при запуске. Наборы миграций для каждого backend встраиваются при сборке и выбираются по типу БД (`sqlite://`, `postgres://`, `mysql://`).

## Технологии

| | |
|---|---|
| Язык | Rust (edition 2024) |
| Веб-фреймворк | Axum 0.8 |
| Асинхронная среда | Tokio |
| База данных | SQLx (SQLite / PostgreSQL / MySQL) |
| Шаблонизатор | Tera |
| UI-фреймворк | Bootstrap 5 + Bootstrap Icons |
| Хеширование паролей | Argon2 |
| Парсинг XML | quick-xml |
| Параллелизм | Rayon + DashMap |

## Производительность

Результаты нагрузочного тестирования Apache Bench — [BENCHMARK.md](BENCHMARK.md) (~29K req/s, ~135K req/s с keep-alive).

## Лицензия

Двойная лицензия: [MIT](LICENSE) или [Apache-2.0](LICENSE), на ваш выбор.
